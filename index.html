<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Armorel CB-5 Catch Basin Generator</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:40px; background:#f9f9f9;}
    .box {max-width:600px; background:white; padding:30px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
    h1 {color:#1e40af;}
    input, select {width:100%; padding:10px; margin:8px 0; font-size:16px; border:1px solid #ccc; border-radius:4px;}
    button {margin-top:20px; padding:12px 24px; font-size:18px; background:#1e40af; color:white; border:none; border-radius:6px; cursor:pointer;}
    button:hover {background:#1e3a8a;}
    .status {margin-top:15px; font-weight:bold;}
  </style>
</head>
<body>
  <div class="box">
    <h1>Murphy – Armorel CB-5 Generator</h1>
    <p>Enter dimensions (e.g. 6'-6" or 5.5) and click Generate.</p>

    <label>Length (L)</label>
    <input id="L" value="6'-0\"" placeholder="6'-0&quot;">

    <label>Width (W)</label>
    <input id="W" value="4'-0\"" placeholder="4'-0&quot;">

    <label>Depth (D)</label>
    <input id="D" value="5'-0\"" placeholder="5'-0&quot;">

    <label>Wall/Floor Thickness</label>
    <input id="T" value="8&quot;" placeholder="8&quot;">

    <label>Grate Type</label>
    <select id="grate">
      <option value="STD">Standard Bicycle-Safe</option>
      <option value="HEAVY">Heavy Duty (Type H)</option>
    </select>

    <button onclick="generate()">Generate & Download DXF</button>
    <div class="status" id="status"></div>
  </div>

  <script>
    let pyodide;
    async function loadPyodideAndPackage() {
      document.getElementById("status").textContent = "Loading Python engine… (first time only, ~15 sec)";
      pyodide = await loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/"});
      
      document.getElementById("status").textContent = "Loading DXF library…";
      await pyodide.loadPackage("micropip");
      await pyodide.runPythonAsync(`
        import micropip
        await micropip.install("https://cdn.jsdelivr.net/npm/ezdxf-wasm@0.2.5/dist/ezdxf_wasm-0.2.5-py3-none-any.whl")
      `);
      document.getElementById("status").textContent = "Ready! Click Generate.";
    }

    // Auto-start loading when page opens
    loadPyodideAndPackage();

    function parseDim(s) {
      s = s.trim().replace(/"/g,'');
      if (s.includes("'")) {
        const [feet, inches = "0"] = s.split("'");
        return parseInt(feet) + parseFloat(inches)/12;
      }
      return parseFloat(s) || 5.0;
    }

    async function generate() {
      if (!pyodide) { alert("Still loading… wait a few more seconds"); return; }
      document.getElementById("status").textContent = "Generating DXF…";

      const L = parseDim(document.getElementById("L").value);
      const W = parseDim(document.getElementById("W").value);
      const D = parseDim(document.getElementById("D").value);
      const T = parseDim(document.getElementById("T").value) / 12; // to feet
      const grate = document.getElementById("grate").value;

      const code = `
import ezdxf
from ezdxf import units

doc = ezdxf.new('R2018', setup=True)
doc.units = units.USSurveyFeet
msp = doc.modelspace()

# Layers matching your original drawing
for name, color in [("0",7), ("Defpoints",7), ("DIM",3), ("TEXT",2), ("HATCH",5), ("CENTER",1), ("GRATE",4), ("TITLE",6)]:
    doc.layers.add(name, color=color)

# Outer walls
msp.add_lwpolyline([(0,0),(L,0),(L,W),(0,W),(0,0)], dxfattribs={"layer":"0"})
# Inner cavity
msp.add_lwpolyline([(T,T),(L-T,T),(L-T,W-T),(T,W-T),(T,T)], dxfattribs={"layer":"0"})

# Floor hatch
hatch = msp.add_hatch(color=5, dxfattribs={"layer":"HATCH"})
path = hatch.paths.add_edge_path()
for x in [(0,0),(L,0),(L,W),(0,W)]: path.add_line(x, x)

# Centerlines
msp.add_line((L/2,0),(L/2,W), dxfattribs={"layer":"CENTER","linetype":"CENTER"})
msp.add_line((0,W/2),(L,W/2), dxfattribs={"layer":"CENTER","linetype":"CENTER"})

# Simple grate block
blk = doc.blocks.new("GRATE_BLOCK")
blk.add_lwpolyline([(0,0),(2,0),(2,1),(0,1),(0,0)])
blk.add_circle((1,0.5), 0.4)
msp.add_blockref("GRATE_BLOCK", (L/2,W/2), dxfattribs={"xscale":W/2, "yscale":W/2, "layer":"GRATE"})

# Title & notes (exactly like your drawing)
msp.add_mtext("ARMOREL - CB-5\\PSTANDARD CATCH BASIN", 
              dxfattribs={"insert":(L+1,W+0.5), "char_height":0.3, "layer":"TITLE"})
notes = ["ALL CONCRETE 4000 PSI MIN.", "REBAR #4 @ 12\\" O.C. E.W.", "4\\" CHAMFER ALL CORNERS"]
y = W + 1.8
for note in notes:
    msp.add_text(note, dxfattribs={"insert":(0.5,y), "height":0.15, "layer":"TEXT"})
    y -= 0.3

# Dimensions
dim = msp.add_linear_dim(base=(0,-0.6), p1=(0,0), p2=(L,0), dimstyle="Standard", layer="DIM"); dim.render()
dim = msp.add_linear_dim(base=(-0.6,0), p1=(0,0), p2=(0,W), angle=90, dimstyle="Standard", layer="DIM"); dim.render()

doc.saveas("MURPHY_ARMOREL_CB-5.dxf")
`;

      await pyodide.runPythonAsync(code);

      const data = pyodide.FS.readFile("MURPHY_ARMOREL_CB-5.dxf");
      const blob = new Blob([data], {type: "application/octet-stream"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `MURPHY_ARMOREL_CB-5_${L.toFixed(2)}x${W.toFixed(2)}.dxf`;
      a.click();
      URL.revokeObjectURL(url);

      document.getElementById("status").textContent = "DXF downloaded! Generate another?";
    }
  </script>
</body>
</html>
